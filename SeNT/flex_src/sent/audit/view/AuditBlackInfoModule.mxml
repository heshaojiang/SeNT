<?xml version="1.0" encoding="utf-8"?>
<grg:TabModule xmlns:fx="http://ns.adobe.com/mxml/2009" 
				xmlns:s="library://ns.adobe.com/flex/spark" 
				xmlns:mx="library://ns.adobe.com/flex/mx" 
				xmlns:grg="http://grg.grgbanking.com/platform/"  
				xmlns:parsley="http://www.spicefactory.org/parsley"
				dataDictionaryPaths="{[BlackRegulationConsts.RULE_STATUS]}"
				layout="vertical" 
				xmlns:userDefined="platform.date.*"
				width="100%" height="100%">
	
	<fx:Declarations>
		<parsley:ContextBuilder>
			<parsley:ViewSettings autoremoveViewRoots="false"/>
			<parsley:FlexConfig type="{AuditBlackInfoModuleConfig}"/>
			<parsley:FlexConfig type="{DataDictConfig}"/>
		</parsley:ContextBuilder>
		<parsley:Configure/>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import platform.common.formatter.DateFormatter;
			import platform.common.manager.AlertHandler;
			import platform.common.manager.PopUpManager;
			import platform.common.vo.Page;
			import platform.dataDict.DataDictConfig;
			
			import sent.audit.config.AuditBlackInfoModuleConfig;
			import sent.audit.pm.AuditBlackInfoModulePM;
			import sent.audit.vo.AuditBlackDetailVO;
			import sent.common.utils.DateUtils;
			import sent.rule.constants.BlackRegulationConsts;
			import platform.common.manager.LanguageManager;

			
			
			[Inject]
			[Bindable]
			public var pm:AuditBlackInfoModulePM;
			
			
			[Bindable]
			/**
			 * 待审核的数量
			 */
			public var prePareAuditCount:int=0;
			
			/**
			 *规则审核按钮的图标
			 **/
			[Bindable]
			[Embed(source="resources/theme/images/audit.png")] 
			private var audit:Class; 
			
			/**
			 * 初始化数据
			 */		
			override protected function viewUpdateComplete():void
			{  
				trace("AuditBlackInfoModule.viewUpdateComplete");
				loadPage();
				prePareAuditCount=pm.auditCount;
			}
			
			override public function dispose():void
			{
				trace("AuditBlackInfoModule.dispose");
				applyDate.selectedDate = new Date();
				endTime.selectedDate = new Date();
				pm.page=new Page();
			}
			/**
			 * 用数据字典转换列表数据
			 */
			override protected function transferDataDict(p_item:Object, p_column:DataGridColumn):String
			{
				switch(p_column.dataField)
				{
					case "ruleStatus":
						currentDataDictPath = BlackRegulationConsts.RULE_STATUS;
						break;
				}
				return super.transferDataDict(p_item, p_column);
			}
			
			/**
			 * 根据条件查询
			 */
			private function loadPage():void
			{
				trace("AuditBlackInfoModule.loadPage");
				if( this.applyDate.selectedDate.time > this.endTime.selectedDate.time )
				{
					AlertHandler.alert(LanguageManager.getInstance().getExceptionMessage("exceptionMessage.startTimeCannotBeGreaterThanEndTime"));
					return;
				}
				pm.loadAuditInfoBlackPage();
			}
			
			/**
			 * 审核
			 */
			public function auditInfo():void
			{
				trace("AuditBlackInfoModule.auditInfo");
				if (!auditDetails.checkedItems || auditDetails.checkedItems.length < 1 ||auditDetails.checkedItems.length>1){
					AlertHandler.alert("noSelectedRecord");//最多选择一条
					return;
				}
				
				var obj:AuditBlackDetailVO = auditDetails.checkedItems[0] as AuditBlackDetailVO;
				var win:ShowAuditBlackInfo= new ShowAuditBlackInfo();
				win.pm = pm;
				win.blackRegulation = obj;
				win.applyDate = DateFormatter.format(obj.applyDate, "YYYY-MM-DD JJ:NN:SS");
				_context.viewManager.addViewRoot(win);
				PopUpManager.showForm4Parsley(win);
				win.titleKey="regulationAuditTitle";
			}
			
			public function initSelectDate():void
			{
				applyDate.selectedDate = DateUtils.createDate(-6, 'YYYY-MM-DD JJ:NN:SS');
				endTime.selectedDate = DateUtils.createDate(1, 'YYYY-MM-DD JJ:NN:SS');
			}
		]]>
	</fx:Script>
	
	<fx:Binding source="applyDate.selectedDate" destination="pm.condi.startTime"/>
	<fx:Binding source="endTime.selectedDate" destination="pm.condi.endTime"/>
	
	<mx:VDividedBox width="100%" height="100%">
		<s:BorderContainer 
			width="100%" height="100%"
			styleName="BorderContainer">
			<s:layout>
				<s:VerticalLayout gap="0" />
			</s:layout>
			<mx:HBox width="100%" styleName="firHBoxStyle" height="30">
				<mx:HBox width="100%" styleName="senHBoxStyle" height="30" verticalAlign="middle" paddingBottom="3" paddingTop="2">
					<mx:HBox styleName="searchStyle">
						<s:BorderContainer width="100%" height="25" backgroundAlpha="0" borderVisible="false">
							<s:layout>
								<s:HorizontalLayout 
									horizontalAlign="left"
									paddingLeft="0"
									gap="2"
									verticalAlign="middle"/>
							</s:layout>
							<!--申请时间：-->
							<grg:Label locale="applyDateColon" />
							<userDefined:SuperDateField width="170" id="applyDate" myEnabled="false" 
												selectedDate="{DateUtils.createDate(-6, 'YYYY-MM-DD JJ:NN:SS')}"
												selectableRange="{{rangeEnd:endTime.selectedDate}}" isShowTime="true" />
							<grg:Label locale="to"/>
							<userDefined:SuperDateField width="170" id="endTime"  myEnabled="false" 
												selectedDate="{DateUtils.createDate(1, 'YYYY-MM-DD JJ:NN:SS')}"
												selectableRange="{{rangeStart:applyDate.selectedDate}}" isShowTime="true" />
							<!--查询-->
							<grg:SearchButton id="btn_search" menuId="{menu.id}"
											  locale="searchButton" 
											  iconType="query" click="pm.page=new Page();loadPage()"/>
							<!--重置-->
							<grg:ResetButton id="resetBtn" iconType="reset" locale="resetButton" click="initSelectDate()"
											 resetControls="{[applyDate, endTime]}"/>
						</s:BorderContainer>
					</mx:HBox> 
				</mx:HBox>
			</mx:HBox> 
			
			<mx:HBox width="100%" height="30" verticalAlign="top" paddingLeft="10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       " >
				<s:BorderContainer styleName="moduleButtonBarstyle" height="25">
					<s:layout>
						<s:HorizontalLayout paddingLeft="4" paddingTop="2" />
					</s:layout>
					<!--审核规则-->
					<grg:Button icon="{audit}" locale="auditInfo" click="auditInfo()"/>
				</s:BorderContainer>
			</mx:HBox>
			
			<grg:DataGrid dataProvider="{pm.page.result}" id="auditDetails" 
						  width="100%" height="100%"
						  styleName="DataGrid">
				<grg:columns>
					<grg:CheckBoxColumn id="checkBoxCol" />
					<!--规则-->
					<grg:DataGridColumn locale="regulation"
										dataField="regulation" textAlign="center" width="200"/>
					<!--规则状态-->
					<grg:DataGridColumn locale="ruleStatus" labelFunction="{transferDataDict}" width="100"
										dataField="ruleStatus" textAlign="center"/>
					<!--申请人-->
					<grg:DataGridColumn locale="applyName" width="200"
										dataField="applyId" textAlign="center"/>
					
					<!--申请机构-->
					<grg:RODataGridColumn locale="applyOrg" width="200"
										  dataField="applyOrgName" textAlign="center"/>
					
					<!--申请时间-->
					<grg:DataGridColumn locale="applyDate" labelFunction="{dateFormatter}" textAlign="center" width="220"
										dataField="applyDate"/>
					
				</grg:columns>
			</grg:DataGrid>
			<grg:PageNavigatorBar id="buttonPagingBar" bottom="0"   pageVo="{pm.page}" pagingFunction="{loadPage}"/>
		</s:BorderContainer>
	</mx:VDividedBox>
</grg:TabModule>

