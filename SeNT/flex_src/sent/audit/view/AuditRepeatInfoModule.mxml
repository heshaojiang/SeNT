<?xml version="1.0" encoding="utf-8"?>
<grg:TabModule xmlns:fx="http://ns.adobe.com/mxml/2009" 
				xmlns:s="library://ns.adobe.com/flex/spark" 
				xmlns:grg="http://grg.grgbanking.com/platform/" 
				xmlns:parsley="http://www.spicefactory.org/parsley"
				xmlns:mx="library://ns.adobe.com/flex/mx" 
				xmlns:userDefined="platform.date.*"
				dataDictionaryPaths="{[AuditLogConstants.APPLY_STATUS, AuditLogConstants.APPLY_TYPE]}"
				layout="vertical" width="100%" height="100%">
	<fx:Declarations>
		<parsley:ContextBuilder>
			<parsley:ViewSettings autoremoveViewRoots="false"/>
			<parsley:FlexConfig type="{AuditRepeatInfoModuleConfig}"/>
			<parsley:FlexConfig type="{DataDictConfig}"/>
		</parsley:ContextBuilder>
		<parsley:Configure/>
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import mx.collections.ArrayCollection;
			import mx.collections.ListCollectionView;
			import mx.utils.ObjectProxy;
			import mx.utils.ObjectUtil;
			
			import platform.common.manager.AlertHandler;
			import platform.common.manager.LanguageManager;
			import platform.common.manager.PopUpManager;
			import platform.common.vo.Page;
			import platform.dataDict.DataDictConfig;
			
			import sent.audit.config.AuditRepeatInfoModuleConfig;
			import sent.audit.constants.AuditLogConstants;
			import sent.audit.message.AuditRepeatInfoMsg;
			import sent.audit.pm.AuditRepeatInfoModulePM;
			import sent.audit.vo.AuditInfoDetailVO;
			
			[Inject]
			[Bindable]
			public var pm:AuditRepeatInfoModulePM;
			
			//待审核的数量
			[Bindable]
			public var prePareAuditCount:int=0;
			/**
			 * 申请类型
			 */
			[Bindable]
			private var applype:ArrayCollection;
			/**
			 *规则审核按钮的图标
			 **/
			[Bindable]
			[Embed(source="resources/theme/images/audit.png")] 
			private var audit:Class; 
			/**
			 *审核状态 
			 */
			[Bindable]
			private var applyStatus:ArrayCollection=new ArrayCollection();
			/**
			 * 初始化数据
			 */		
			override protected function viewUpdateComplete():void
			{  
				loadRepeatPage();
				prePareAuditCount=pm.auditCount;
			}
			/**
			 *获取数据字典后更新信息
			 *  
			 */
			
			override protected function getDataDictCallback():void
			{
				var str:String  = LanguageManager.getInstance().getCommonLanguageMap("components")["all"] as String ;
				var allItem:Object = {key:"", text:str};
				var arrCol1:ArrayCollection = ObjectUtil.copy(dataDictionaryCache[AuditLogConstants.APPLY_TYPE]) as ArrayCollection;
				arrCol1.addItemAt(allItem, 0);
				applype= arrCol1;
				
				(auditDetails.dataProvider as ListCollectionView).refresh();
			} 
			
			/**
			 * 显示数据字典转换出来的值
			 */
			override protected function transferDataDict(p_item:Object, column:DataGridColumn):String
			{
				if(column.dataField == "applyType")
					currentDataDictPath = AuditLogConstants.APPLY_TYPE;
				
				return super.transferDataDict(p_item, column);
			}
			override public function dispose():void
			{
				applayDate.selectedDate = new Date();
				endTime.selectedDate = new Date();
				pm.page=new Page();
				
			}
			
			/**
			 * 根据条件查询
			 * 
			 */
			
			private function loadRepeatPage():void
			{
				pm.loadAuditInfoRepeatPage();
				
			}
			
			/**
			 * 审核
			 * 
			 */
			
			public function auditInfo():void
			{
				if (!auditDetails.checkedItems || auditDetails.checkedItems.length < 1 ||auditDetails.checkedItems.length>1){
					AlertHandler.alert("noSelectedRecord");//最多选择一条
					return;
				}
				
				var obj:AuditInfoDetailVO =auditDetails.selectedItem as AuditInfoDetailVO;
				var win:ShowAuditRepeatInfo= new ShowAuditRepeatInfo();
				win.pm=pm;
				win.auditDetail=obj;
				win.auditInfo=new ObjectProxy(obj);
				_context.viewManager.addViewRoot(win);
				PopUpManager.showForm4Parsley(win);
				win.titleKey="regulationAuditTitle";
				//对应的申请信息（详情）
				
				var auditMsg:AuditRepeatInfoMsg=new AuditRepeatInfoMsg();
				auditMsg.type="getRepeatAuditInfo";
				auditMsg.args["applyId"]=obj.applyId;
				sendMessage(auditMsg);
				
				//审核信息
				var auditLogMsg:AuditRepeatInfoMsg=new AuditRepeatInfoMsg();
				auditLogMsg.type="getRepeatAuditLogByApplyId";
				auditLogMsg.args["applyId"]=obj.applyId;
				sendMessage(auditLogMsg);
				
				//申请类型
				var applayType:String=obj.applyType;
				
				//查找规则类型审核详情
				var msg:AuditRepeatInfoMsg= new AuditRepeatInfoMsg();
				msg.type = "getRepeatRegulationByApplyId";
				msg.args["applyId"] = obj.applyId;
				sendMessage(msg); 
				
			
				
				
				
			}
			
		]]>
	</fx:Script>
	<fx:Binding source="applayDate.selectedDate" destination="pm.condi.startTime"/>
	<fx:Binding source="endTime.selectedDate" destination="pm.condi.endTime"/>
	<!--<fx:Binding source="applytyp.selectedValue" destination="pm.audit.applytyp"/>-->
	<!--	<fx:Binding source="auditStatus.selectedValue" destination="pm.audit.auditStatus"/>-->
	<mx:VDividedBox width="100%" height="100%">
		<s:BorderContainer 
			width="100%" height="100%"
			styleName = "BorderContainer">
			<s:layout>
				<s:VerticalLayout gap="0" />
			</s:layout>
			<mx:HBox width="100%" styleName="firHBoxStyle" height="30">
				<mx:HBox width="100%" styleName="senHBoxStyle" height="30" verticalAlign="middle" paddingBottom="3" paddingTop="2">
					<mx:HBox styleName="searchStyle">
						<s:BorderContainer width = "100%" height = "25" backgroundAlpha="0" borderVisible = "false">
							<s:layout>
								<s:HorizontalLayout 
									horizontalAlign = "left"
									paddingLeft = "0"
									gap="2"
									verticalAlign = "middle"/>
							</s:layout>
							<!--申请时间：-->
							<grg:Label locale="applayDate" />
							<userDefined:SuperDateField width="190" id="applayDate" myEnabled="false" selectableRange="{{rangeEnd:endTime.selectedDate}}" isShowTime="true" />
							<grg:Label locale="to"/>
							<userDefined:SuperDateField width="190" id="endTime"  myEnabled="false" selectableRange="{{rangeStart:applayDate.selectedDate}}" isShowTime="true" />
							
							
							<!--查询-->
							<grg:SearchButton id="btn_search" menuId="{menu.id}"
											  locale = "searchButton" 
											  iconType = "query" click="pm.page = new Page();loadRepeatPage()"/>
							
							
							<!--重置-->
							<grg:ResetButton id="resetBtn" iconType="reset" locale="resetButton" 
											 resetControls="{[applayDate, endTime]}"/>
						</s:BorderContainer>
					</mx:HBox> 
				</mx:HBox>
			</mx:HBox> 
			<mx:HBox width="100%" height="30" verticalAlign="top" paddingLeft="10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       " >
				<s:BorderContainer styleName="moduleButtonBarstyle" height="25">
					<s:layout>
						<s:HorizontalLayout paddingLeft="4" paddingTop="2" />
					</s:layout>
					<!--审核规则-->
					<grg:Button icon="{audit}" locale="auditInfo" click="auditInfo()"/>
				</s:BorderContainer>
				
			</mx:HBox>
			<!--<mx:HBox width="100%" height="100%" styleName="datagridHBoxStyle">-->
			<grg:DataGrid dataProvider="{pm.page.result}" id="auditDetails" 
						  width="100%" height="100%"
						  styleName = "DataGrid">
				<grg:columns>
					<grg:CheckBoxColumn id="checkBoxCol" />
					<!--申请人-->
					<grg:DataGridColumn locale = "applyName"
										dataField = "username" textAlign="left" width="200"/>
					<!--申请时间：-->
					<grg:DataGridColumn locale = "applayDate" 
										dataField = "applayDate" textAlign="center" width="250">
						<grg:itemRenderer>
							<fx:Component>
								<s:MXItemRenderer>
									<fx:Script>
										<![CDATA[
											[Bindable]
											private var dateString:String;
											override public function set data(value:Object):void
											{
												//日期格式化
												super.data = value;
												var trDate:String=value.applayDate.substr(0,4)+"-"+value.applayDate.substr(4,2)+"-"+value.applayDate.substr(6,2)
												var trTime:String=value.applayDate.substr(8,2)+":"+value.applayDate.substr(10,2)+":"+value.applayDate.substr(12,2);
												
												dateString=trDate+" "+trTime;
											}
										]]>
									</fx:Script>
									<grg:Label text="{dateString}" toolTip="{dateString}"  fontSize="14" textAlign="center" width="250"/>
								</s:MXItemRenderer>
							</fx:Component>
						</grg:itemRenderer>
					</grg:DataGridColumn>
					<!--申请类型：-->
					<grg:DataGridColumn locale = "applytyp" 
										dataField = "applyType" width="250" labelFunction="{transferDataDict}" textAlign="left"/>
					<!--申请机构-->
					<grg:DataGridColumn locale = "orgId" 
										dataField = "orgName" textAlign="left" width="250"/>
					
				</grg:columns>
			</grg:DataGrid>
			<grg:PageNavigatorBar id="buttonPagingBar" bottom = "0" 
								  pageVo="{pm.page}"
								  pagingFunction="{loadRepeatPage}"/>
		</s:BorderContainer>
	</mx:VDividedBox>
</grg:TabModule>
